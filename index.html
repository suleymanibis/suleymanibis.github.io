<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Satranç (Çok Oyunculu)</title>
    <!-- Gerekli Kütüphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f0f0f0; }
    
    .hidden { display: none !important; }

    /* Ana Menü ve Lobi Stilleri */
    #mainMenu, #gameLobby {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 500px;
        padding: 40px;
        background-color: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        text-align: center;
    }
    #mainMenu button {
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 15px;
        border-radius: 10px;
        transition: all 0.2s ease;
    }
    #mainMenu button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    /* Oyun Alanı ve Diğer Stiller */
    .game-area { display: none; }
    .main-content-wrapper { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1200px; }
    .game-container { background-color: #fff; border: 4px solid #333; border-radius: 12px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); padding: 20px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; position: relative; }
    .board { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); width: 400px; height: 400px; border: 2px solid #555; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); border-radius: 8px; overflow: hidden; }
    .square { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 2.8rem; cursor: grab; user-select: none; transition: background-color 0.2s ease; position: relative; }
    .light { background-color: #f0d9b5; }
    .dark { background-color: #b58863; }
    .selected { background-color: #a4c639 !important; }
    .piece { line-height: 1; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); pointer-events: none; }
    .piece.white { color: #ececec; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    .info-panel, .game-info-panel { margin-top: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; color: #333; min-height: 25px; }
    .message-box { color: #4a5568; font-size: 1rem; margin-top: 5px; min-height: 20px; font-weight: 500;}
    .game-over-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 2.5rem; font-weight: bold; text-align: center; border-radius: 12px; z-index: 10; }
    .game-over-overlay button, #backToMenuButton { margin-top: 20px; padding: 12px 25px; font-size: 1.2rem; font-weight: bold; color: white; background-color: #007bff; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .game-over-overlay button:hover, #backToMenuButton:hover { background-color: #0056b3; }
    .game-history-container { background-color: #fff; border: 2px solid #ccc; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); padding: 20px; width: 350px; display: flex; flex-direction: column; align-items: center; max-height: 550px; overflow-y: auto; }
</style>
</head>
<body class="p-5 flex flex-col justify-center items-center min-h-screen">
    <div id="mainMenu">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Web Satranç</h1>
        <p id="currentUserIdDisplay" class="text-gray-500 font-medium text-sm mb-6">Kullanıcı: Yükleniyor...</p>
        <button id="playVsBotBtn" class="bg-purple-600 text-white hover:bg-purple-700">Bilgisayara Karşı Oyna</button>
        <button id="createOnlineGameBtn" class="bg-green-600 text-white hover:bg-green-700">Online Oyun Oluştur</button>
        <button id="joinOnlineGameBtn" class="bg-blue-600 text-white hover:bg-blue-700">Açık Oyunları Gör</button>
        <button id="playLocalBtn" class="bg-gray-600 text-white hover:bg-gray-700">İki Kişi Oyna (Yerel)</button>
    </div>

    <div id="gameLobby" class="hidden">
        <h2 class="text-2xl font-bold text-center mb-4">Açık Oyunlar</h2>
        <div id="lobbyList" class="space-y-2 h-64 overflow-y-auto p-2 bg-gray-50 border rounded">
            <p class="text-gray-500 text-center">Oyunlar yükleniyor...</p>
        </div>
        <button id="backToMenuFromLobbyBtn" class="w-full mt-4 bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600">Ana Menüye Dön</button>
    </div>

    <div class="game-area main-content-wrapper">
        <div class="game-container">
            <div class="game-info-panel" id="gameInfoPanel"></div>
            <div class="message-box" id="messageBox"></div>
            <div class="board" id="chessBoard"></div>
            <div class="game-over-overlay hidden" id="gameOverOverlay">
                <p>Oyun Bitti!</p>
                <p id="gameOverMessage"></p>
                <button id="rematchButton">Tekrar Oyna</button>
                <button id="mainMenuButton">Ana Menü</button>
            </div>
            <button id="backToMenuButton" class="mt-4 bg-red-500 hover:bg-red-600">Ana Menüye Dön</button>
        </div>
        <div class="game-history-container hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, getDoc, updateDoc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAcMo_abVNc5XMXkeV594HCw4REwFohHoU",
            authDomain: "chess-788b3.firebaseapp.com",
            projectId: "chess-788b3",
            storageBucket: "chess-788b3.appspot.com",
            messagingSenderId: "180730302373",
            appId: "1:180730302373:web:ee36639e0349a6d882224c",
            measurementId: "G-ZC9ED69EB9"
        };

        let db, auth, userId;
        let chess, playerColor, gameId, gameUnsubscribe, lobbyUnsubscribe;
        let gameMode = null, audioStarted = false, fromSquare = null, currentGameStatus = 'ended';
        
        const mainMenu = document.getElementById('mainMenu');
        const gameLobby = document.getElementById('gameLobby');
        const lobbyList = document.getElementById('lobbyList');
        const gameArea = document.querySelector('.game-area');
        const chessBoardDiv = document.getElementById('chessBoard');
        const gameInfoPanel = document.getElementById('gameInfoPanel');
        const messageBox = document.getElementById('messageBox');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const gameOverMessage = document.getElementById('gameOverMessage');

        const PIECE_SYMBOLS = { 'k': '♚', 'q': '♛', 'r': '♜', 'b': '♝', 'n': '♞', 'p': '♟', 'K': '♔', 'Q': '♕', 'R': '♖', 'B': '♗', 'N': '♘', 'P': '♙' };
        const moveSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const captureSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 } }).toDestination();

        function startAudio() { if (!audioStarted) { Tone.start(); audioStarted = true; } }

        async function showMainMenu() {
            if (gameId && currentGameStatus === 'waiting') {
                await deleteDoc(doc(db, "games", gameId));
            }
            mainMenu.style.display = 'flex';
            gameArea.style.display = 'none';
            gameLobby.classList.add('hidden');
            if (gameUnsubscribe) gameUnsubscribe();
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            gameMode = null; gameId = null;
            gameOverOverlay.classList.add('hidden');
        }

        function showLobby() {
            if (!userId) { alert("Lütfen önce Firebase bağlantısının kurulmasını bekleyin."); return; }
            mainMenu.style.display = 'none';
            gameLobby.classList.remove('hidden');
            gameLobby.style.display = 'flex';
            
            const q = query(collection(db, "games"), where("status", "==", "waiting"), orderBy("createdAt", "desc"));
            
            lobbyUnsubscribe = onSnapshot(q, (snapshot) => {
                lobbyList.innerHTML = '';
                if (snapshot.empty) {
                    lobbyList.innerHTML = '<p class="text-gray-500 text-center">Açık oyun bulunmuyor.</p>';
                    return;
                }
                snapshot.forEach(gameDoc => {
                    const gameData = gameDoc.data();
                    
                    // *** DÜZELTME: Kendi oyununu gizleme mantığı geçici olarak kaldırıldı. ***
                    // Bu satır, aynı bilgisayarda test yaparken soruna neden olabilir.
                    // Gerçek dağıtımda bu kontrolü geri ekleyebilirsiniz:
                    // if(gameData.creatorId === userId) return;

                    const gameElement = document.createElement('div');
                    gameElement.className = 'p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 flex justify-between items-center';
                    gameElement.innerHTML = `<span>Oda: ${gameDoc.id.substring(0, 5)}...</span><span class="text-sm text-gray-600">Kurucu: ${gameData.creatorId.substring(0, 5)}...</span>`;
                    gameElement.onclick = () => joinOnlineGame(gameDoc.id);
                    lobbyList.appendChild(gameElement);
                });
            }, (error) => {
                console.error("Lobi sorgusu hatası:", error);
                lobbyList.innerHTML = `<p class="text-red-500 text-center">Oyunlar yüklenemedi. <br>Hata: ${error.message} <br>Lütfen Firestore indeksini ve kurallarını kontrol edin!</p>`;
            });
        }

        function showGameUI(mode) {
            gameMode = mode; chess = new Chess(); fromSquare = null;
            mainMenu.style.display = 'none';
            gameLobby.classList.add('hidden');
            gameArea.style.display = 'flex';
            renderBoard();
        }

        function renderBoard() {
            chessBoardDiv.innerHTML = '';
            const board = chess.board();
            const isFlipped = playerColor === 'black';
            for (let i = 0; i < 8; i++) for (let j = 0; j < 8; j++) {
                const row = isFlipped ? 7 - i : i; const col = isFlipped ? 7 - j : j;
                const squareData = board[row][col]; const squareName = String.fromCharCode(97 + col) + (8 - row);
                const square = document.createElement('div');
                square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                square.dataset.square = squareName;
                if (squareData) {
                    const pieceElement = document.createElement('span');
                    pieceElement.className = `piece ${squareData.color === 'w' ? 'white' : ''}`;
                    pieceElement.innerHTML = PIECE_SYMBOLS[squareData.color === 'w' ? squareData.type.toUpperCase() : squareData.type];
                    square.appendChild(pieceElement);
                }
                chessBoardDiv.appendChild(square);
            }
            updateGameInfo();
        }

        function updateGameInfo() {
            let statusText = '';
            if (chess.game_over()) {
                gameOverOverlay.classList.remove('hidden'); currentGameStatus = 'ended';
                if (chess.in_checkmate()) statusText = `Şah Mat! Kazanan: ${chess.turn() === 'w' ? 'Siyah' : 'Beyaz'}`;
                else if (chess.in_draw()) statusText = 'Oyun Berabere';
                gameOverMessage.textContent = statusText;
            } else {
                if (currentGameStatus === 'waiting') statusText = `Oda Kodu: ${gameId}. Rakip bekleniyor...`;
                else {
                    statusText = `Sıra: ${chess.turn() === 'w' ? 'Beyaz' : 'Siyah'}`;
                    if (chess.in_check()) statusText += ' (Şah!)';
                }
            }
            gameInfoPanel.textContent = statusText;
            let subText = '';
            if (gameMode === 'online') subText = `Sen ${playerColor === 'white' ? 'Beyaz' : 'Siyah'} taşsın.`;
            messageBox.textContent = subText;
        }

        function startLocalGame() { showGameUI('local'); }
        function startBotGame() { playerColor = 'white'; showGameUI('bot'); }

        async function createOnlineGame() {
            showGameUI('online'); playerColor = 'white';
            const gameRef = await addDoc(collection(db, "games"), {
                fen: new Chess().fen(), creatorId: userId, opponentId: null,
                status: 'waiting', createdAt: serverTimestamp()
            });
            gameId = gameRef.id;
            listenToGame(gameId);
        }

        async function joinOnlineGame(code) {
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            const gameRef = doc(db, "games", code);
            const gameSnap = await getDoc(gameRef);
            if (gameSnap.exists() && gameSnap.data().status === 'waiting' && gameSnap.data().creatorId !== userId) {
                await updateDoc(gameRef, { opponentId: userId, status: 'active' });
                gameId = code; playerColor = 'black';
                showGameUI('online');
                listenToGame(gameId);
            } else { alert("Oyun bulunamadı, dolu veya bu sizin kendi oyununuz!"); showLobby(); }
        }

        function listenToGame(gId) {
            gameId = gId;
            gameUnsubscribe = onSnapshot(doc(db, "games", gId), (docSnap) => {
                if (!docSnap.exists()) {
                    if (currentGameStatus !== 'ended') alert("Oyun kurucu tarafından iptal edildi veya silindi!");
                    showMainMenu(); return;
                }
                const gameData = docSnap.data();
                if (currentGameStatus === 'waiting' && gameData.status === 'active') messageBox.textContent = "Rakip bulundu! Oyun başlıyor.";
                currentGameStatus = gameData.status;
                if (chess.fen() !== gameData.fen) { chess.load(gameData.fen); renderBoard(); }
                updateGameInfo();
            });
        }

        function handleMove(move) {
            const result = chess.move(move);
            if (result) {
                (result.flags.includes('c') || result.flags.includes('e')) ? captureSynth.triggerAttackRelease("A3", "8n") : moveSynth.triggerAttackRelease("C4", "8n");
                renderBoard();
                if (gameMode === 'online') updateDoc(doc(db, "games", gameId), { fen: chess.fen() });
                else if (gameMode === 'bot' && chess.turn() === 'b' && !chess.game_over()) setTimeout(makeBotMove, 250);
            }
            return result;
        }

        function onSquareClick(squareElement) {
            startAudio();
            if (chess.game_over() || currentGameStatus !== 'active') return;
            const square = squareElement.dataset.square;
            const isMyTurn = (gameMode === 'local' || (gameMode === 'bot' && chess.turn() === 'w') || (gameMode === 'online' && ((playerColor === 'white' && chess.turn() === 'w') || (playerColor === 'black' && chess.turn() === 'b'))));
            if (!isMyTurn) return;
            if (!fromSquare) {
                const piece = chess.get(square);
                if (piece && piece.color === chess.turn()) fromSquare = square;
            } else {
                const move = { from: fromSquare, to: square, promotion: 'q' };
                if (!handleMove(move)) {
                    const piece = chess.get(square);
                    if (piece && piece.color === chess.turn()) fromSquare = square;
                    else fromSquare = null;
                } else fromSquare = null;
            }
        }

        function makeBotMove() {
            const possibleMoves = chess.moves({ verbose: true });
            if (possibleMoves.length === 0) return;
            const move = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
            handleMove(move);
        }

        async function initializeFirebaseApp() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; document.getElementById('currentUserIdDisplay').textContent = `Kullanıcı: Aktif`; } 
                    else { document.getElementById('currentUserIdDisplay').textContent = "Kullanıcı: Oturum Açılamadı."; }
                });
            } catch (error) { console.error("Firebase Hatası:", error); }
        }

        document.getElementById('playVsBotBtn').addEventListener('click', () => { startAudio(); startBotGame(); });
        document.getElementById('createOnlineGameBtn').addEventListener('click', () => { startAudio(); createOnlineGame(); });
        document.getElementById('joinOnlineGameBtn').addEventListener('click', () => { startAudio(); showLobby(); });
        document.getElementById('playLocalBtn').addEventListener('click', () => { startAudio(); startLocalGame(); });
        document.getElementById('backToMenuFromLobbyBtn').addEventListener('click', showMainMenu);
        document.getElementById('backToMenuButton').addEventListener('click', showMainMenu);
        document.getElementById('mainMenuButton').addEventListener('click', showMainMenu);
        document.getElementById('rematchButton').addEventListener('click', () => alert("Tekrar oynama özelliği yakında!"));
        chessBoardDiv.addEventListener('click', (e) => { const squareElement = e.target.closest('.square'); if (squareElement) onSquareClick(squareElement); });
        
        window.addEventListener('load', () => { initializeFirebaseApp(); showMainMenu(); });
    </script>
</body>
</html>