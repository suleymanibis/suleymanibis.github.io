<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Satranç (Çok Oyunculu)</title>
    <!-- Gerekli Kütüphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    body { 
        font-family: 'Inter', sans-serif; 
        background-color: #312e2b; /* Koyu tema arkaplan */
        color: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }
    
    .hidden { display: none !important; }

    /* --- Ana Menü ve Lobi --- */
    #mainMenu, #gameLobby {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 450px;
        padding: 40px;
        background-color: #3c3a38; /* Koyu menü */
        border: 1px solid #545250;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        text-align: center;
    }
    #mainMenu h1, #gameLobby h2 {
        color: #e6e6e6;
    }
    #mainMenu button {
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 15px;
        border: none;
        border-radius: 10px;
        transition: all 0.2s ease-in-out;
        color: white;
    }
    #mainMenu button:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }
    #lobbyList {
        width: 100%;
    }
    #lobbyList > div {
        background-color: #4a4846;
        color: #d1d1d1;
    }
    #lobbyList > div:hover {
        background-color: #5a5856;
    }
    #backToMenuFromLobbyBtn {
        background-color: #63615f !important;
    }
    
    /* --- Oyun Alanı --- */
    .game-area { display: none; }
    .main-content-wrapper { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1200px; }
    .game-container { 
        background-color: #3c3a38; 
        border: 1px solid #545250;
        border-radius: 12px; 
        padding: 20px; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        position: relative; 
    }
    .board { 
        display: grid; 
        grid-template-columns: repeat(8, 1fr); 
        width: 440px; 
        height: 440px; 
        border-radius: 8px; 
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .square { 
        width: 100%; 
        height: 100%; 
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .square .piece {
        width: 85%;
        height: 85%;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        cursor: grab;
        position: relative;
        z-index: 5;
    }
    .light { background-color: #ebecd0; }
    .dark { background-color: #779556; }

    /* --- VURGULAMA STİLLERİ --- */
    .selected-square::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(246, 246, 130, 0.6); /* Sarı vurgu */
        z-index: 1;
    }
    .possible-move-dot::after {
        content: '';
        position: absolute;
        width: 35%;
        height: 35%;
        background-color: rgba(0, 0, 0, 0.15);
        border-radius: 50%;
        z-index: 2;
    }
    .possible-capture-ring {
        box-shadow: inset 0 0 0 4px rgba(0, 0, 0, 0.15);
    }

    /* Paneller ve Butonlar */
    .game-info-panel, .message-box {
        color: #c7c7c7;
    }
    .game-over-overlay {
        background-color: rgba(0, 0, 0, 0.8);
    }
    .game-over-overlay button, #backToMenuButton {
        background-color: #4a69bd;
        transition: background-color 0.2s ease;
    }
    .game-over-overlay button:hover, #backToMenuButton:hover {
        background-color: #5c7ee6;
    }
</style>
</head>
<body class="p-5 flex flex-col justify-center items-center min-h-screen">
    <div id="mainMenu">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Web Satranç</h1>
        <p id="currentUserIdDisplay" class="text-gray-500 font-medium text-sm mb-6">Kullanıcı: Yükleniyor...</p>
        
        <button id="playVsBotBtn" class="bg-purple-600 text-white hover:bg-purple-700">Bilgisayara Karşı Oyna</button>
        <button id="createOnlineGameBtn" class="bg-green-600 text-white hover:bg-green-700">Online Oyun Oluştur</button>
        <button id="joinOnlineGameBtn" class="bg-blue-600 text-white hover:bg-blue-700">Açık Oyunları Gör</button>
        <button id="playLocalBtn" class="bg-gray-600 text-white hover:bg-gray-700">İki Kişi Oyna (Yerel)</button>
    </div>

    <div id="gameLobby" class="hidden">
        <h2 class="text-2xl font-bold text-center mb-4">Açık Oyunlar</h2>
        <div id="lobbyList" class="space-y-2 h-64 overflow-y-auto p-2 bg-gray-800 border border-gray-700 rounded">
            <!-- Açık oyunlar buraya yüklenecek -->
        </div>
        <button id="backToMenuFromLobbyBtn" class="w-full mt-4 bg-gray-600 text-white p-3 rounded-lg hover:bg-gray-700">Ana Menüye Dön</button>
    </div>

    <div class="game-area main-content-wrapper">
        <div class="game-container">
            <div class="game-info-panel" id="gameInfoPanel"></div>
            <div class="message-box" id="messageBox"></div>
            <div class="board" id="chessBoard"></div>
            <div class="game-over-overlay hidden" id="gameOverOverlay">
                <p>Oyun Bitti!</p>
                <p id="gameOverMessage"></p>
                <button id="rematchButton">Tekrar Oyna</button>
                <button id="mainMenuButton">Ana Menü</button>
            </div>
            <button id="backToMenuButton" class="mt-4 bg-red-600 hover:bg-red-700">Ana Menüye Dön</button>
        </div>
        <div class="game-history-container hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, getDoc, updateDoc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAcMo_abVNc5XMXkeV594HCw4REwFohHoU",
            authDomain: "chess-788b3.firebaseapp.com",
            projectId: "chess-788b3",
            storageBucket: "chess-788b3.appspot.com",
            messagingSenderId: "180730302373",
            appId: "1:180730302373:web:ee36639e0349a6d882224c",
            measurementId: "G-ZC9ED69EB9"
        };

        // Global Değişkenler
        let db, auth, userId;
        let chess, playerColor, gameId, gameUnsubscribe, lobbyUnsubscribe;
        let gameMode = null, audioStarted = false, fromSquare = null, currentGameStatus = 'ended';
        
        const mainMenu = document.getElementById('mainMenu');
        const gameLobby = document.getElementById('gameLobby');
        const lobbyList = document.getElementById('lobbyList');
        const gameArea = document.querySelector('.game-area');
        const chessBoardDiv = document.getElementById('chessBoard');
        const gameInfoPanel = document.getElementById('gameInfoPanel');
        const messageBox = document.getElementById('messageBox');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const gameOverMessage = document.getElementById('gameOverMessage');

        const PIECE_SVG_URLS = {
            'wP': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg', 'wN': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
            'wB': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg', 'wR': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
            'wQ': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg', 'wK': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
            'bP': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg', 'bN': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
            'bB': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg', 'bR': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
            'bQ': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg', 'bK': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
        };
        const moveSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const captureSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 } }).toDestination();

        function startAudio() { if (!audioStarted) { Tone.start(); audioStarted = true; } }

        async function showMainMenu() {
            if (gameId && currentGameStatus === 'waiting') await deleteDoc(doc(db, "games", gameId));
            mainMenu.style.display = 'flex';
            gameArea.style.display = 'none';
            gameLobby.classList.add('hidden');
            if (gameUnsubscribe) gameUnsubscribe();
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            gameMode = null; gameId = null;
            gameOverOverlay.classList.add('hidden');
        }

        function showLobby() {
            if (!userId) { alert("Lütfen Firebase bağlantısını bekleyin."); return; }
            mainMenu.style.display = 'none';
            gameLobby.classList.remove('hidden');
            gameLobby.style.display = 'flex';
            const q = query(collection(db, "games"), where("status", "==", "waiting"), orderBy("createdAt", "desc"));
            lobbyUnsubscribe = onSnapshot(q, (snapshot) => {
                lobbyList.innerHTML = '<p class="text-gray-400 text-center">Açık oyun bulunmuyor.</p>';
                if (!snapshot.empty) lobbyList.innerHTML = '';
                snapshot.forEach(gameDoc => {
                    const gameData = gameDoc.data();
                    if(gameData.creatorId === userId) return;
                    const gameElement = document.createElement('div');
                    gameElement.className = 'p-3 rounded-lg cursor-pointer flex justify-between items-center';
                    gameElement.onclick = () => joinOnlineGame(gameDoc.id);
                    gameElement.innerHTML = `<span>Oda: ${gameDoc.id.substring(0, 5)}...</span><span class="text-sm text-gray-500">Kurucu: ${gameData.creatorId.substring(0,5)}...</span>`;
                    lobbyList.appendChild(gameElement);
                });
            }, (error) => {
                console.error("Lobi hatası:", error);
                lobbyList.innerHTML = `<p class="text-red-400 text-center">Oyunlar yüklenemedi. İndeks/Kural hatası olabilir.</p>`;
            });
        }

        function showGameUI(mode) {
            gameMode = mode; chess = new Chess(); fromSquare = null;
            mainMenu.style.display = 'none';
            gameLobby.classList.add('hidden');
            gameArea.style.display = 'flex';
            renderBoard();
        }

        function renderBoard() {
            chessBoardDiv.innerHTML = '';
            const board = chess.board();
            const isFlipped = playerColor === 'black';
            for (let i = 0; i < 8; i++) for (let j = 0; j < 8; j++) {
                const row = isFlipped ? 7 - i : i; const col = isFlipped ? 7 - j : j;
                const squareData = board[row][col];
                const squareName = String.fromCharCode(97 + col) + (8 - row);
                const square = document.createElement('div');
                square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                square.dataset.square = squareName;
                if (squareData) {
                    const pieceKey = squareData.color + squareData.type.toUpperCase();
                    const pieceElement = document.createElement('div');
                    pieceElement.className = 'piece';
                    pieceElement.style.backgroundImage = `url(${PIECE_SVG_URLS[pieceKey]})`;
                    square.appendChild(pieceElement);
                }
                chessBoardDiv.appendChild(square);
            }
            updateGameInfo();
        }
        
        function clearHighlights() {
            document.querySelectorAll('.square').forEach(s => {
                s.classList.remove('selected-square', 'possible-capture-ring');
                const dot = s.querySelector('.possible-move-dot');
                if(dot) dot.remove();
            });
        }

        function highlightPossibleMoves(sourceSquare) {
            clearHighlights();
            document.querySelector(`[data-square=${sourceSquare}]`).classList.add('selected-square');
            const moves = chess.moves({ square: sourceSquare, verbose: true });
            moves.forEach(move => {
                const targetSquare = document.querySelector(`[data-square=${move.to}]`);
                if (move.flags.includes('c') || move.flags.includes('e')) {
                    targetSquare.classList.add('possible-capture-ring');
                } else {
                    const dot = document.createElement('div');
                    dot.className = 'possible-move-dot';
                    targetSquare.appendChild(dot);
                }
            });
        }

        function updateGameInfo() {
            let statusText = '';
            if (chess.game_over()) {
                gameOverOverlay.classList.remove('hidden'); currentGameStatus = 'ended';
                if (chess.in_checkmate()) statusText = `Şah Mat! Kazanan: ${chess.turn() === 'w' ? 'Siyah' : 'Beyaz'}`;
                else if (chess.in_draw()) statusText = 'Oyun Berabere';
                gameOverMessage.textContent = statusText;
            } else {
                if (currentGameStatus === 'waiting') statusText = `Oda Kodu: ${gameId}`;
                else {
                    statusText = `Sıra: ${chess.turn() === 'w' ? 'Beyaz' : 'Siyah'}`;
                    if (chess.in_check()) statusText += ' (Şah!)';
                }
            }
            gameInfoPanel.textContent = statusText;
            let subText = '';
            if (gameMode === 'online') {
                subText = `Sen ${playerColor === 'white' ? 'Beyaz' : 'Siyah'} taşsın.`;
                if(currentGameStatus === 'waiting') subText += ' Rakip bekleniyor...';
            }
            messageBox.textContent = subText;
        }

        function startLocalGame() { showGameUI('local'); }
        function startBotGame() { playerColor = 'white'; showGameUI('bot'); }

        async function createOnlineGame() {
            showGameUI('online'); playerColor = 'white';
            const gameRef = await addDoc(collection(db, "games"), {
                fen: new Chess().fen(), creatorId: userId, opponentId: null,
                status: 'waiting', createdAt: serverTimestamp()
            });
            gameId = gameRef.id;
            listenToGame(gameId);
        }

        async function joinOnlineGame(code) {
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            const gameRef = doc(db, "games", code);
            const gameSnap = await getDoc(gameRef);
            if (gameSnap.exists() && gameSnap.data().status === 'waiting' && gameSnap.data().creatorId !== userId) {
                await updateDoc(gameRef, { opponentId: userId, status: 'active' });
                gameId = code; playerColor = 'black';
                showGameUI('online');
                listenToGame(gameId);
            } else { alert("Oyun bulunamadı, dolu veya bu sizin kendi oyununuz!"); showLobby(); }
        }

        function listenToGame(gId) {
            gameId = gId;
            gameUnsubscribe = onSnapshot(doc(db, "games", gId), (docSnap) => {
                if (!docSnap.exists()) {
                    if (currentGameStatus !== 'ended') alert("Oyun kurucu tarafından iptal edildi!");
                    showMainMenu(); return;
                }
                const gameData = docSnap.data();
                if (currentGameStatus === 'waiting' && gameData.status === 'active') messageBox.textContent = "Rakip bulundu! Oyun başlıyor.";
                currentGameStatus = gameData.status;
                if (chess.fen() !== gameData.fen) {
                    chess.load(gameData.fen);
                    clearHighlights();
                    renderBoard();
                }
                updateGameInfo();
            });
        }

        function handleMove(move) {
            const result = chess.move(move);
            if (result) {
                (result.flags.includes('c') || result.flags.includes('e')) ? captureSynth.triggerAttackRelease("A3", "8n") : moveSynth.triggerAttackRelease("C4", "8n");
                clearHighlights();
                renderBoard();
                if (gameMode === 'online') updateDoc(doc(db, "games", gameId), { fen: chess.fen() });
                else if (gameMode === 'bot' && chess.turn() === 'b' && !chess.game_over()) setTimeout(makeBotMove, 250);
            }
            return result;
        }

        function onSquareClick(squareElement) {
            startAudio();
            if (chess.game_over() || currentGameStatus !== 'active') return;
            const square = squareElement.dataset.square;
            const isMyTurn = (gameMode === 'local' || (gameMode === 'bot' && chess.turn() === 'w') || (gameMode === 'online' && ((playerColor === 'white' && chess.turn() === 'w') || (playerColor === 'black' && chess.turn() === 'b'))));
            if (!isMyTurn) return;

            if (!fromSquare) {
                const piece = chess.get(square);
                if (piece && piece.color === chess.turn()) {
                    fromSquare = square;
                    highlightPossibleMoves(square);
                }
            } else {
                const move = { from: fromSquare, to: square, promotion: 'q' };
                if (!handleMove(move)) {
                    clearHighlights();
                    const piece = chess.get(square);
                    if (piece && piece.color === chess.turn()) {
                        fromSquare = square;
                        highlightPossibleMoves(square);
                    } else fromSquare = null;
                } else fromSquare = null;
            }
        }

        function makeBotMove() {
            const possibleMoves = chess.moves({ verbose: true });
            if (possibleMoves.length === 0) return;
            const move = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
            handleMove(move);
        }

        async function initializeFirebaseApp() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; document.getElementById('currentUserIdDisplay').textContent = `Kullanıcı: Aktif`; } 
                    else document.getElementById('currentUserIdDisplay').textContent = "Oturum Açılamadı.";
                });
            } catch (error) { console.error("Firebase Hatası:", error); }
        }

        // Olay Atamaları
        document.getElementById('playVsBotBtn').addEventListener('click', () => { startAudio(); startBotGame(); });
        document.getElementById('createOnlineGameBtn').addEventListener('click', () => { startAudio(); createOnlineGame(); });
        document.getElementById('joinOnlineGameBtn').addEventListener('click', () => { startAudio(); showLobby(); });
        document.getElementById('playLocalBtn').addEventListener('click', () => { startAudio(); startLocalGame(); });
        document.getElementById('backToMenuFromLobbyBtn').addEventListener('click', showMainMenu);
        document.getElementById('backToMenuButton').addEventListener('click', showMainMenu);
        document.getElementById('mainMenuButton').addEventListener('click', showMainMenu);
        document.getElementById('rematchButton').addEventListener('click', () => alert("Yakında!"));
        chessBoardDiv.addEventListener('click', (e) => { const squareElement = e.target.closest('.square'); if (squareElement) onSquareClick(squareElement); });
        
        window.addEventListener('load', () => { initializeFirebaseApp(); showMainMenu(); });
    </script>
</body>
</html>