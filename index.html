<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Satranç (Pro)</title>
    <!-- Gerekli Kütüphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root {
        --bg-dark: #262421; --bg-medium: #302e2c; --bg-light: #3c3a38;
        --text-light: #e6e6e6; --text-dark: #9e9c9a;
        --accent-green: #7fa650; --accent-blue: #4a69bd;
    }
    body { 
        font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-light);
        display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 15px;
        overflow: hidden; /* Sayfa kaymasını engelle */
    }
    .hidden { display: none !important; }
    button { transition: all 0.2s ease-in-out; }
    button:hover { transform: translateY(-2px); }

    /* --- Modal Stilleri (Oda Oluşturma) --- */
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 99; display: flex; justify-content: center; align-items: center; }
    .modal-content { background-color: var(--bg-light); padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); width: 90%; max-width: 400px; }
    .modal-content h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; }
    .modal-content input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #545250; background-color: var(--bg-medium); color: var(--text-light); margin-bottom: 15px; }
    .modal-content .modal-buttons { display: flex; gap: 10px; }
    .modal-content button { flex-grow: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; color: white; }

    /* --- Ana Menü ve Lobi --- */
    #mainMenu, #gameLobby { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 450px; padding: 40px; background-color: var(--bg-medium); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; }
    #mainMenu button { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 600; margin-top: 15px; border: none; border-radius: 10px; color: white; }
    #lobbyList > div { background-color: var(--bg-light); color: var(--text-light); }
    #lobbyList > div:hover { background-color: #4a4846; }

    /* --- Oyun Alanı --- */
    .game-area { display: none; }
    .main-content-wrapper { display: flex; flex-direction: row; gap: 30px; align-items: flex-start; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1200px; }
    .game-container { background-color: var(--bg-medium); border: 1px solid #545250; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; position: relative; }
    .board { display: grid; grid-template-columns: repeat(8, 1fr); width: 440px; height: 440px; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    .square { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
    .square .piece { width: 85%; height: 85%; background-size: contain; background-position: center; background-repeat: no-repeat; cursor: grab; position: relative; z-index: 5; }
    .light { background-color: #ebecd0; }
    .dark { background-color: #779556; }

    /* --- Vurgulama Stilleri --- */
    .selected-square::before { content: ''; position: absolute; inset: 0; background-color: rgba(246, 246, 130, 0.6); z-index: 1; }
    .in-check::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle, rgba(255,50,50,0.7) 30%, rgba(255,50,50,0) 70%); z-index: 2; animation: pulse 1.2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    .possible-move-dot { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; position: absolute; z-index: 2; }
    .possible-move-dot::after { content: ''; width: 30%; height: 30%; background-color: rgba(0, 0, 0, 0.2); border-radius: 50%; }
    .possible-capture-ring { box-shadow: inset 0 0 0 4px rgba(0, 0, 0, 0.15); }
    
    /* OYUN BİTİŞ EKRANI - DÜZENLENMİŞ TASARIM */
    .game-over-overlay {
        position: fixed; 
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
        text-align: center;
        opacity: 0; 
        transform: scale(1.1);
        transition: opacity 0.3s ease, transform 0.3s ease;
        pointer-events: none; 
        z-index: 100;
    }
    .game-over-overlay.visible {
        opacity: 1; 
        transform: scale(1); 
        pointer-events: auto;
    }
    .game-over-overlay h2 { font-size: 2.8rem; font-weight: 700; margin-bottom: 4px; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
    .game-over-overlay p { font-size: 1.2rem; color: #d1d1d1; margin-bottom: 30px; }
    .game-over-overlay #gameOverIcon { font-size: 4rem; margin-bottom: 1rem; text-shadow: 0 0 15px rgba(0,0,0,0.4); }
    .game-over-overlay button { background-color: var(--accent-blue); padding: 12px 28px; border-radius: 8px; font-weight: 600; color: white; border: none; }
    .game-over-overlay button.rematch-requested { background-color: var(--accent-green); }
    </style>
</head>
<body class="p-5">
    <div id="mainMenu">
        <h1 class="text-4xl font-bold mb-2">Web Satranç</h1>
        <p id="currentUserIdDisplay" class="text-gray-400 font-medium text-sm mb-6">Kullanıcı: Yükleniyor...</p>
        <button id="playVsBotBtn" class="bg-purple-600">Bilgisayara Karşı Oyna</button>
        <button id="createOnlineGameBtn" class="bg-green-600">Online Oyun Oluştur</button>
        <button id="joinOnlineGameBtn" class="bg-blue-600">Açık Oyunları Gör</button>
        <button id="playLocalBtn" class="bg-gray-600">İki Kişi Oyna (Yerel)</button>
    </div>

    <div id="createGameModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2>Yeni Online Oyun</h2>
            <input type="text" id="roomNameInput" placeholder="Oda Adı" maxlength="20">
            <input type="password" id="roomPasswordInput" placeholder="Şifre (isteğe bağlı)">
            <div class="modal-buttons">
                <button id="cancelCreateGameBtn" class="bg-gray-600">İptal</button>
                <button id="confirmCreateGameBtn" class="bg-green-600">Oluştur</button>
            </div>
        </div>
    </div>
    
    <div id="gameLobby" class="hidden">
        <h2 class="text-2xl font-bold text-center mb-4">Açık Oyunlar</h2>
        <div id="lobbyList" class="space-y-2 h-64 w-full overflow-y-auto p-2 bg-gray-900 border border-gray-700 rounded"></div>
        <button id="backToMenuFromLobbyBtn" class="w-full mt-4 bg-gray-600 text-white p-3 rounded-lg hover:bg-gray-700">Ana Menüye Dön</button>
    </div>

    <div class="game-area main-content-wrapper">
        <div class="game-container">
            <div id="playerTop" class="text-center font-semibold mb-2 h-6">Oyuncu 2 (Siyah)</div>
            <div class="board" id="chessBoard"></div>
            <div id="playerBottom" class="text-center font-semibold mt-2 h-6">Oyuncu 1 (Beyaz)</div>
            <div class="game-info-panel" id="gameInfoPanel">Sıra: Beyaz</div>
            <button id="backToMenuButton" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg">Ana Menüye Dön</button>
        </div>
        <!-- Diğer oyun elemanları buraya gelebilir, mesela hamle listesi -->
        <div class="game-history-container hidden"></div>
    </div>

    <!-- Oyun bitiş ekranı, diğer tüm elementlerden sonra, body'nin doğrudan içinde yer alıyor. -->
    <div id="gameOverOverlay" class="game-over-overlay hidden">
        <div id="gameOverIcon"></div>
        <h2 id="gameOverTitle"></h2>
        <p id="gameOverMessage"></p>
        <div class="flex gap-4 mt-4">
            <button id="rematchButton">Tekrar Oyna</button>
            <button id="mainMenuButton">Ana Menü</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, getDoc, updateDoc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase yapılandırmanızı buraya yapıştırın
        const firebaseConfig = {
            apiKey: "AIzaSyAcMo_abVNc5XMXkeV594HCw4REwFohHoU",
            authDomain: "chess-788b3.firebaseapp.com",
            projectId: "chess-788b3",
            storageBucket: "chess-788b3.appspot.com",
            messagingSenderId: "180730302373",
            appId: "1:180730302373:web:ee36639e0349a6d882224c",
            measurementId: "G-ZC9ED69EB9"
        };

        let db, auth, userId, guestName;
        let chess, playerColor, gameId, gameUnsubscribe, lobbyUnsubscribe;
        let gameMode = null, audioStarted = false, fromSquare = null, currentGameStatus = 'ended';
        
        const mainMenu = document.getElementById('mainMenu');
        const createGameModal = document.getElementById('createGameModal');
        const gameLobby = document.getElementById('gameLobby');
        const lobbyList = document.getElementById('lobbyList');
        const gameArea = document.querySelector('.game-area');
        const chessBoardDiv = document.getElementById('chessBoard');
        const playerTop = document.getElementById('playerTop');
        const playerBottom = document.getElementById('playerBottom');
        const gameInfoPanel = document.getElementById('gameInfoPanel');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const gameOverIcon = document.getElementById('gameOverIcon');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const rematchButton = document.getElementById('rematchButton');
        const mainMenuButton = document.getElementById('mainMenuButton');


        const PIECE_SVG_URLS = { 'wP': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg', 'wN': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg', 'wB': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg', 'wR': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg', 'wQ': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg', 'wK': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg', 'bP': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg', 'bN': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg', 'bB': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg', 'bR': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg', 'bQ': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg', 'bK': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg' };
        const moveSynth = new Tone.Synth().toDestination();
        const captureSynth = new Tone.MembraneSynth().toDestination();
        const checkSynth = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
        const winSynth = new Tone.PolySynth(Tone.Synth, { "volume": -8, "envelope": { "attack": 0.01, "decay": 0.5, "sustain": 0.2, "release": 0.5 } }).toDestination();
        const lossSynth = new Tone.Synth({ oscillator: { type: "fmsine" }, envelope: { attack: 0.1, decay: 0.5, sustain: 0, release: 1 } }).toDestination();
        const drawSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.5 } }).toDestination();

        function startAudio() { if (!audioStarted) { Tone.start(); audioStarted = true; } }

        // --- YENİ & GÜNCELLENMİŞ FONKSİYON ---
        async function showMainMenu() {
            // Online bir oyundan çıkılıyorsa, durumu veritabanında güncelle
            if (gameMode === 'online' && gameId && (currentGameStatus === 'active' || currentGameStatus === 'waiting')) {
                const gameRef = doc(db, "games", gameId);
                try {
                    const gameSnap = await getDoc(gameRef);
                    if (gameSnap.exists()) {
                        const gameData = gameSnap.data();
                        // Rakip beklenirken oyundan çıkılırsa, oyunu tamamen sil
                        if (gameData.status === 'waiting' && gameData.creatorId === userId) {
                            await deleteDoc(gameRef);
                        } 
                        // Aktif bir oyun sırasında çıkılırsa, oyunu 'terk edilmiş' olarak işaretle
                        else if (gameData.status === 'active') {
                            const winnerColor = (gameData.creatorId === userId) ? 'black' : 'white';
                            await updateDoc(gameRef, { status: 'abandoned', winner: winnerColor });
                        }
                    }
                } catch(error) {
                    console.error("Oyundan çıkarken hata oluştu:", error);
                }
            }

            // Arayüzü temizle ve ana menüyü göster
            mainMenu.style.display = 'flex';
            gameArea.style.display = 'none';
            createGameModal.classList.add('hidden');
            gameLobby.classList.add('hidden');
            if (gameUnsubscribe) gameUnsubscribe();
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            
            gameOverOverlay.classList.remove('visible');
            setTimeout(() => { gameOverOverlay.classList.add('hidden'); }, 300);

            gameMode = null; gameId = null; currentGameStatus = 'ended';
        }

        function showCreateGameModal() { createGameModal.classList.remove('hidden'); }
        function hideCreateGameModal() { createGameModal.classList.add('hidden'); }
        
        function showLobby() {
            if (!userId) return;
            mainMenu.style.display = 'none';
            gameLobby.classList.remove('hidden');
            gameLobby.style.display = 'flex';
            const q = query(collection(db, "games"), where("status", "==", "waiting"), orderBy("createdAt", "desc"));
            lobbyUnsubscribe = onSnapshot(q, (snapshot) => {
                lobbyList.innerHTML = '<p class="text-gray-400 text-center">Açık oyun bulunmuyor.</p>';
                if (snapshot.empty) return;
                lobbyList.innerHTML = '';
                snapshot.forEach(gameDoc => {
                    const gameData = gameDoc.data();
                    const gameElement = document.createElement('div');
                    gameElement.className = 'p-3 rounded-lg cursor-pointer flex justify-between items-center';
                    gameElement.onclick = () => joinOnlineGame(gameDoc.id, gameData.password);
                    const lockIcon = gameData.password ? '' : ''; // Kilit emojisi
                    gameElement.innerHTML = `<span>${gameData.roomName || 'İsimsiz Oda'} ${lockIcon}</span><span class="text-sm text-gray-400">Kurucu: ${gameData.creatorName || 'Misafir'}</span>`;
                    lobbyList.appendChild(gameElement);
                });
            });
        }

        function showGameUI(mode) {
            gameMode = mode; chess = new Chess(); fromSquare = null;
            mainMenu.style.display = 'none';
            gameLobby.classList.add('hidden');
            gameArea.style.display = 'flex';
            renderBoard();
        }

        function renderBoard() {
            chessBoardDiv.innerHTML = '';
            const board = chess.board();
            const isFlipped = (gameMode === 'online' && playerColor === 'black');
            for (let i = 0; i < 8; i++) for (let j = 0; j < 8; j++) {
                const row = isFlipped ? 7 - i : i; const col = isFlipped ? 7 - j : j;
                const squareData = board[row][col]; const squareName = String.fromCharCode(97 + col) + (8 - row);
                const square = document.createElement('div');
                square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                square.dataset.square = squareName;
                if (squareData) {
                    const pieceKey = squareData.color + squareData.type.toUpperCase();
                    const pieceElement = document.createElement('div');
                    pieceElement.className = 'piece';
                    pieceElement.style.backgroundImage = `url(${PIECE_SVG_URLS[pieceKey]})`;
                    square.appendChild(pieceElement);
                }
                chessBoardDiv.appendChild(square);
            }
            updateGameInfo({});
        }
        
        function clearHighlights() {
            document.querySelectorAll('.square').forEach(s => s.classList.remove('selected-square', 'in-check', 'possible-capture-ring'));
            document.querySelectorAll('.possible-move-dot').forEach(dot => dot.remove());
        }

        function highlightPossibleMoves(sourceSquare) {
            clearHighlights();
            document.querySelector(`[data-square=${sourceSquare}]`).classList.add('selected-square');
            const moves = chess.moves({ square: sourceSquare, verbose: true });
            moves.forEach(move => {
                const targetSquare = document.querySelector(`[data-square=${move.to}]`);
                if (move.flags.includes('c') || move.flags.includes('e')) {
                    targetSquare.classList.add('possible-capture-ring');
                } else {
                    const dot = document.createElement('div');
                    dot.className = 'possible-move-dot';
                    targetSquare.appendChild(dot);
                }
            });
        }
        
        function findKingSquare(color) {
            const board = chess.board();
            for (let i = 0; i < 8; i++) for (let j = 0; j < 8; j++) {
                const piece = board[i][j];
                if (piece && piece.type === 'k' && piece.color === color) {
                    return String.fromCharCode(97 + j) + (8 - i);
                }
            }
            return null;
        }

        function highlightCheck() {
            const kingSquare = findKingSquare(chess.turn());
            if (kingSquare) document.querySelector(`[data-square=${kingSquare}]`).classList.add('in-check');
        }

        function updateGameInfo(gameData) {
            if (gameMode === 'online') {
                if(playerColor === 'white') {
                    playerBottom.textContent = `Siz (${gameData.creatorName || guestName})`;
                    playerTop.textContent = gameData.opponentName ? `Rakip (${gameData.opponentName})` : 'Rakip Bekleniyor...';
                } else {
                    playerBottom.textContent = `Siz (${gameData.opponentName || guestName})`;
                    playerTop.textContent = `Rakip (${gameData.creatorName || 'Bilinmiyor'})`;
                }
            } else {
                 playerTop.textContent = gameMode === 'bot' ? 'Bot (Siyah)' : 'Oyuncu 2 (Siyah)';
                 playerBottom.textContent = gameMode === 'bot' ? `${guestName} (Beyaz)` : 'Oyuncu 1 (Beyaz)';
            }
            
            if (currentGameStatus === 'waiting') { 
                gameInfoPanel.textContent = `Oyun Kodu: ${gameId} | Rakip bekleniyor...`;
            } else if (currentGameStatus === 'active' && !chess.game_over()) {
                let statusText = `Sıra: ${chess.turn() === 'w' ? 'Beyaz' : 'Siyah'}`;
                if (chess.in_check()) statusText += ' (Şah!)';
                gameInfoPanel.textContent = statusText;
            }
            
            rematchButton.textContent = "Tekrar Oyna";
            rematchButton.classList.remove('rematch-requested');
            if(gameMode === 'online' && gameData.rematchRequestedBy) {
                if(gameData.rematchRequestedBy !== userId) {
                    rematchButton.textContent = "Tekrar Oyna (Kabul Et)";
                    rematchButton.classList.add('rematch-requested');
                } else {
                    rematchButton.textContent = "İstek Gönderildi";
                }
            }
        }
        
        // --- YENİ YARDIMCI FONKSİYON ---
        function showGameOver(title, message, icon, playWinSound = false, playLossSound = false) {
            currentGameStatus = 'ended';
            
            if (playWinSound) winSynth.triggerAttackRelease(["C4", "E4", "G4"], "0.5");
            else if (playLossSound) lossSynth.triggerAttackRelease("C3", "1");
            else drawSynth.triggerAttackRelease("A3", "1");

            gameOverIcon.textContent = icon;
            gameOverTitle.textContent = title;
            gameOverMessage.textContent = message;
            
            gameOverOverlay.classList.remove('hidden');
            setTimeout(() => { gameOverOverlay.classList.add('visible'); }, 10);
        }

        function checkGameOver() {
            if (!chess.game_over()) return;
            
            const winnerColor = chess.turn() === 'w' ? 'Siyah' : 'Beyaz';
            let title = '', message = '', icon = '', isWin = false;

            if (chess.in_checkmate()) {
                title = "Şah Mat!"; 
                message = `Kazanan: ${winnerColor}`; 
                icon = '👑';
                if (gameMode === 'online') isWin = (winnerColor.toLowerCase() === playerColor);
                else if (gameMode === 'bot') isWin = (winnerColor === 'Beyaz');
                
                showGameOver(title, message, icon, isWin, !isWin);
            } else {
                title = "Berabere!"; 
                icon = '🤝';
                if (chess.in_stalemate()) message = "Pat durumu nedeniyle berabere.";
                else if (chess.in_threefold_repetition()) message = "Üç tekrar kuralı nedeniyle berabere.";
                else if (chess.insufficient_material()) message = "Yetersiz materyal nedeniyle berabere.";
                else message = "Oyun berabere sonuçlandı.";

                showGameOver(title, message, icon);
            }
        }

        async function createOnlineGame(roomName, password) {
            playerColor = 'white'; 
            showGameUI('online');
            currentGameStatus = 'waiting';
            const gameRef = await addDoc(collection(db, "games"), {
                fen: new Chess().fen(), status: 'waiting', createdAt: serverTimestamp(),
                creatorId: userId, creatorName: guestName, opponentId: null, opponentName: null,
                roomName: roomName, password: password || null, rematchRequestedBy: null, winner: null
            });
            gameId = gameRef.id;
            listenToGame(gameId);
        }

        async function joinOnlineGame(code, password) {
            if (password) {
                const enteredPassword = prompt("Bu oda şifreli. Lütfen şifreyi girin:");
                if (enteredPassword !== password) { alert("Yanlış şifre!"); return; }
            }
            if (lobbyUnsubscribe) lobbyUnsubscribe();
            const gameRef = doc(db, "games", code);
            const gameSnap = await getDoc(gameRef);
            if (gameSnap.exists() && gameSnap.data().status === 'waiting' && gameSnap.data().creatorId !== userId) {
                await updateDoc(gameRef, { opponentId: userId, opponentName: guestName, status: 'active' });
                gameId = code; playerColor = 'black';
                showGameUI('online');
                listenToGame(gameId);
            } else { 
                if (!gameSnap.exists()) alert("Oyun bulunamadı!");
                else if (gameSnap.data().creatorId === userId) alert("Kendi oyununuza katılamazsınız!");
                else alert("Oyun dolu veya başlamış!");
                showLobby(); 
            }
        }

        function listenToGame(gId) {
            gameId = gId;
            gameUnsubscribe = onSnapshot(doc(db, "games", gId), (docSnap) => {
                if (!docSnap.exists()) {
                    if (currentGameStatus !== 'ended') alert("Oyun kurucu tarafından iptal edildi veya bir hata oluştu!");
                    showMainMenu();
                    return;
                }
                const gameData = docSnap.data();
                
                // --- OYUNCU TERK ETME KONTROLÜ ---
                if (gameData.status === 'abandoned') {
                    const isWinner = playerColor === gameData.winner;
                    const message = isWinner ? `Rakibiniz oyunu terk etti. Galip sizsiniz!` : "Oyundan ayrıldığınız için kaybettiniz.";
                    showGameOver("Oyun Bitti", message, isWinner ? '🏆' : '👋', isWinner, !isWinner);
                    if(gameUnsubscribe) gameUnsubscribe(); // Dinleyiciyi durdur
                    return;
                }

                if (currentGameStatus === 'waiting' && gameData.status === 'active') {
                    console.log("Rakip bulundu! Oyun başlıyor.");
                    currentGameStatus = 'active'; // Durumu hemen güncelle
                }

                if (chess.fen() !== gameData.fen) {
                    chess.load(gameData.fen);
                    clearHighlights();
                    renderBoard();
                    if (chess.in_check()) {
                        checkSynth.triggerAttackRelease("A5", "0.2");
                        highlightCheck();
                    }
                }
                
                updateGameInfo(gameData);

                if (gameData.status === 'active' && !gameOverOverlay.classList.contains('hidden')) {
                    gameOverOverlay.classList.remove('visible');
                    setTimeout(() => { gameOverOverlay.classList.add('hidden'); }, 300);
                    currentGameStatus = 'active';
                }

                if (gameData.status === 'ended' && currentGameStatus !== 'ended') {
                    checkGameOver();
                }
            });
        }


        function handleMove(move) {
            const result = chess.move(move);
            if (result) {
                (result.captured) ? captureSynth.triggerAttackRelease("C3", "8n") : moveSynth.triggerAttackRelease("C4", "8n");
                clearHighlights();
                renderBoard();
                if (chess.in_check()) { 
                    checkSynth.triggerAttackRelease("A5", "0.2"); 
                    highlightCheck(); 
                }
                
                if (gameMode === 'online') {
                    updateDoc(doc(db, "games", gameId), { fen: chess.fen(), status: chess.game_over() ? 'ended' : 'active' });
                } else if (gameMode === 'bot' && chess.turn() === 'b' && !chess.game_over()) {
                    setTimeout(makeBotMove, 250);
                }
                
                checkGameOver();
            }
            return result;
        }

        function onSquareClick(squareElement) {
            startAudio();
            if (currentGameStatus !== 'active' && !(gameMode === 'local' && currentGameStatus !== 'ended')) return;


            const isMyTurn = (gameMode === 'local') || 
                             (gameMode === 'bot' && chess.turn() === 'w') ||
                             (gameMode === 'online' && playerColor.charAt(0) === chess.turn());
            
            if (!isMyTurn) return;

            const square = squareElement.dataset.square;
            const piece = chess.get(square);

            if (fromSquare) {
                const move = { from: fromSquare, to: square, promotion: 'q' };
                if (handleMove(move)) {
                    fromSquare = null;
                } else { 
                    clearHighlights();
                    if (piece && piece.color === chess.turn()) {
                        fromSquare = square;
                        highlightPossibleMoves(square);
                    } else {
                        fromSquare = null;
                    }
                }
            } else { 
                if (piece && piece.color === chess.turn()) {
                    fromSquare = square;
                    highlightPossibleMoves(square);
                }
            }
        }

        function makeBotMove() {
            const possibleMoves = chess.moves();
            if (possibleMoves.length === 0) return;
            const move = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
            handleMove(move);
        }
        
        function startLocalGame() { playerColor = 'white'; showGameUI('local'); currentGameStatus = 'active'; }
        function startBotGame() { playerColor = 'white'; showGameUI('bot'); currentGameStatus = 'active'; }

        async function handleRematch() {
            if(gameMode === 'local' || gameMode === 'bot') {
                showGameUI(gameMode);
                currentGameStatus = 'active';
                gameOverOverlay.classList.remove('visible');
                setTimeout(() => gameOverOverlay.classList.add('hidden'), 300);
                return;
            }

            const gameRef = doc(db, "games", gameId);
            const gameSnap = await getDoc(gameRef);
            if(!gameSnap.exists()) return;
            const gameData = gameSnap.data();

            if(gameData.rematchRequestedBy && gameData.rematchRequestedBy !== userId) {
                await updateDoc(gameRef, { 
                    fen: new Chess().fen(), 
                    status: 'active', 
                    rematchRequestedBy: null,
                    winner: null
                });
            } else if (!gameData.rematchRequestedBy) {
                await updateDoc(gameRef, { rematchRequestedBy: userId });
            }
        }

        async function initializeFirebaseApp() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) { 
                        userId = user.uid; 
                        guestName = `Misafir_${userId.substring(0, 5)}`;
                        document.getElementById('currentUserIdDisplay').textContent = `Kullanıcı: ${guestName}`;
                    } 
                    else { document.getElementById('currentUserIdDisplay').textContent = "Oturum Açılamadı."; }
                });
            } catch (error) { console.error("Firebase Hatası:", error); }
        }

        // Event Listeners
        document.getElementById('playVsBotBtn').addEventListener('click', () => { startAudio(); startBotGame(); });
        document.getElementById('createOnlineGameBtn').addEventListener('click', () => { startAudio(); showCreateGameModal(); });
        document.getElementById('confirmCreateGameBtn').addEventListener('click', () => {
            const roomName = document.getElementById('roomNameInput').value;
            const password = document.getElementById('roomPasswordInput').value;
            if(!roomName) { alert("Oda adı boş bırakılamaz!"); return; }
            hideCreateGameModal();
            createOnlineGame(roomName, password);
        });
        document.getElementById('cancelCreateGameBtn').addEventListener('click', hideCreateGameModal);
        document.getElementById('joinOnlineGameBtn').addEventListener('click', () => { startAudio(); showLobby(); });
        document.getElementById('playLocalBtn').addEventListener('click', () => { startAudio(); startLocalGame(); });
        document.getElementById('backToMenuFromLobbyBtn').addEventListener('click', showMainMenu);
        document.getElementById('backToMenuButton').addEventListener('click', showMainMenu);
        mainMenuButton.addEventListener('click', showMainMenu);
        rematchButton.addEventListener('click', handleRematch);
        chessBoardDiv.addEventListener('click', (e) => { const el = e.target.closest('.square'); if (el) onSquareClick(el); });
        
        window.addEventListener('load', () => { 
            initializeFirebaseApp(); 
            showMainMenu(); 
        });
    </script>
</body>
</html>